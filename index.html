<!DOCTYPE html>
<html lang="es">
<head>
<!-- Agrega estas l√≠neas en <head> -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6a1b9a">
<link rel="icon" type="image/png" href="icon-192-ita.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JJ Italiano App</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #f3e5f5);
      margin: 0;
      padding: 15px;
      color: #2c3e50;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 95%;
      margin: 15px auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      text-align: center;
      color: #6a1b9a;
      margin-top: 0;
      font-size: 1.8em;
    }
    h2 {
      color: #0277bd;
      text-align: center;
      font-size: 1.4em;
    }
    button, .opcion {
      display: block;
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    button {
      background: #43a047;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background: #2e7d32;
      transform: translateY(-1px);
    }
    .opcion {
      background: #e1f5fe;
      color: #01579b;
      font-weight: 600;
    }
    .opcion:hover {
      background: #b3e5fc;
    }
    #modo-seleccion button {
      background: #1e88e5;
    }
    #errores, #examen-resultados {
      display: none;
    }
    #errores h2, #examen-resultados h2 {
      color: #c62828;
    }
    hr {
      border: 0;
      border-top: 1px dashed #ccc;
      margin: 12px 0;
    }
    input#respuesta-escrita {
      width: 100%;
      padding: 14px;
      font-size: 1.2em;
      border: 2px solid #ccc;
      border-radius: 12px;
      margin: 10px 0;
      text-align: center;
    }
    .stats {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #555;
    }
    .categoria-btn, .examen-btn {
      background: #ab47bc;
    }
    .categoria-btn:hover, .examen-btn:hover {
      background: #8e24aa;
    }
    .examen-timer {
      text-align: center;
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.2em;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üáÆüáπ Italiano en Acci√≥n</h1>

    <div id="menu-principal">
      <button onclick="mostrarCategorias()">üìö Vocabulario por Categor√≠as</button>
      <button onclick="iniciarVerbos()">üìù Practicar Verbos</button>
      <button class="examen-btn" onclick="iniciarExamen()">üéì Modo Examen</button>
      <div class="stats" id="stats-global"></div>
      <button onclick="mostrarErrores()">‚ùó Mis Errores</button>
    </div>

    <div id="categorias" style="display:none;">
      <h2>Elige una categor√≠a</h2>
      <button class="categoria-btn" onclick="iniciarVocabulario('todo')">Todas las palabras</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('basico')">B√°sico</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('comida')">Comida</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('viajes')">Viajes</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('familia')">Familia</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('casa')">Casa</button>
      <button class="categoria-btn" onclick="iniciarVocabulario('verbos')">Verbos</button>
      <button onclick="document.getElementById('categorias').style.display='none'; document.getElementById('menu-principal').style.display='block';">üîô Volver</button>
    </div>

    <div id="examen-config" style="display:none;">
      <h2>Configurar Examen</h2>
      <p><strong>N√∫mero de preguntas:</strong></p>
      <button onclick="configurarExamen(10)">10 preguntas</button>
      <button onclick="configurarExamen(20)">20 preguntas</button>
      <button onclick="configurarExamen(30)">30 preguntas</button>
      <p><strong>Tiempo l√≠mite (opcional):</strong></p>
      <button onclick="configurarExamen(20, 300)">5 min (20 preguntas)</button>
      <button onclick="configurarExamen(30, 600)">10 min (30 preguntas)</button>
      <button onclick="document.getElementById('examen-config').style.display='none'; document.getElementById('menu-principal').style.display='block';">üîô Volver</button>
    </div>

    <div id="juego" style="display:none;">
      <div class="stats" id="stats-sesion">Pregunta: 1/20</div>
      <div class="examen-timer" id="examen-timer" style="display:none;"></div>
      <h2 id="pregunta">¬øC√≥mo se dice...?</h2>
      
      <div id="opciones">
        <div class="opcion" id="opcion0"></div>
        <div class="opcion" id="opcion1"></div>
        <div class="opcion" id="opcion2"></div>
        <div class="opcion" id="opcion3"></div>
      </div>
      
      <input type="text" id="respuesta-escrita" placeholder="Escribe tu respuesta..." style="display:none;">
      <button id="btn-enviar" style="display:none;">‚úÖ Enviar</button>
      
      <button onclick="toggleModo()">‚ÜîÔ∏è Cambiar modo</button>
      <button onclick="volverMenuJuego()">üîô Men√∫</button>
    </div>
  </div>

  <div class="card" id="errores" style="display:none;">
    <h2>‚ùå Mis Errores</h2>
    <div id="errores-lista"></div>
    <button onclick="reiniciarErrores()">üóëÔ∏è Limpiar errores</button>
    <button onclick="document.getElementById('errores').style.display='none'">Cerrar</button>
  </div>

  <div class="card" id="examen-resultados" style="display:none;">
    <h2>üéì Resultados del Examen</h2>
    <div id="resultados-contenido"></div>
    <button onclick="verDetallesExamen()">üîç Ver respuestas</button>
    <button onclick="document.getElementById('examen-resultados').style.display='none'; document.getElementById('menu-principal').style.display='block';">Men√∫ principal</button>
  </div>

  <script>
    // === AUDIO ===
    let synth = window.speechSynthesis;
    function reproducir(texto) {
      if (synth.speaking) synth.cancel();
      const utter = new SpeechSynthesisUtterance(texto);
      utter.lang = 'it-IT';
      utter.rate = 0.9;
      utter.pitch = 1;
      synth.speak(utter);
    }

    // === VOCABULARIO POR CATEGOR√çAS ===
    const vocabularioPorCategoria = {
      basico: [
        ["hola", "ciao"],["adi√≥s", "arrivederci"],["gracias", "grazie"],["por favor", "per favore"],
        ["s√≠", "s√¨"],["no", "no"],["buenos d√≠as", "buongiorno"],["buenas noches", "buonanotte"],
        ["perd√≥n", "scusa"],["disculpe", "mi scusi"],["agua", "acqua"],["uno", "uno"],["dos", "due"],
        ["tres", "tre"],["cuatro", "quattro"],["cinco", "cinque"],["seis", "sei"],["siete", "sette"],
        ["ocho", "otto"],["nueve", "nove"],["diez", "dieci"]
      ],
      comida: [
        ["pan", "pane"],["vino", "vino"],["caf√©", "caff√®"],["leche", "latte"],["queso", "formaggio"],
        ["manzana", "mela"],["pl√°tano", "banana"],["carne", "carne"],["pescado", "pesce"],
        ["huevo", "uovo"],["arroz", "riso"],["pasta", "pasta"],["sopa", "zuppa"],["az√∫car", "zucchero"],
        ["sal", "sale"],["aceite", "olio"],["agua", "acqua"],["t√©", "t√®"],["cerveza", "birra"]
      ],
      viajes: [
        ["coche", "macchina"],["autob√∫s", "autobus"],["tren", "treno"],["avi√≥n", "aereo"],
        ["calle", "strada"],["ciudad", "citt√†"],["pa√≠s", "paese"],["mundo", "mondo"],
        ["hotel", "albergo"],["estaci√≥n", "stazione"],["aeropuerto", "aeroporto"],["mapa", "mappa"],
        ["derecha", "destra"],["izquierda", "sinistra"],["recto", "dritto"],["cerca", "vicino"],
        ["lejos", "lontano"],["aqu√≠", "qui"],["all√≠", "l√¨"]
      ],
      familia: [
        ["padre", "padre"],["madre", "madre"],["hermano", "fratello"],["hermana", "sorella"],
        ["hijo", "figlio"],["hija", "figlia"],["amigo", "amico"],["amiga", "amica"],
        ["abuelo", "nonno"],["abuela", "nonna"],["t√≠o", "zio"],["t√≠a", "zia"],["primo", "cugino"],
        ["prima", "cugina"],["esposo", "marito"],["esposa", "moglie"]
      ],
      casa: [
        ["casa", "casa"],["puerta", "porta"],["ventana", "finestra"],["habitaci√≥n", "stanza"],
        ["cocina", "cucina"],["ba√±o", "bagno"],["mesa", "tavolo"],["silla", "sedia"],
        ["cama", "letto"],["libro", "libro"],["l√°piz", "matita"],["bol√≠grafo", "penna"],
        ["papel", "carta"],["tel√©fono", "telefono"],["computadora", "computer"],["internet", "internet"],
        ["l√°mpara", "lampada"],["espejo", "specchio"]
      ],
      verbos: [
        ["comer", "mangiare"],["beber", "bere"],["dormir", "dormire"],["trabajar", "lavorare"],
        ["estudiar", "studiare"],["hablar", "parlare"],["escuchar", "ascoltare"],["ver", "vedere"],
        ["leer", "leggere"],["escribir", "scrivere"],["correr", "correre"],["caminar", "camminare"],
        ["ir", "andare"],["venir", "venire"],["hacer", "fare"],["poder", "potere"],["querer", "volere"],
        ["deber", "dovere"],["saber", "sapere"],["conocer", "conoscere"]
      ]
    };

    let todo = [];
    for (let cat in vocabularioPorCategoria) {
      todo = todo.concat(vocabularioPorCategoria[cat]);
    }
    vocabularioPorCategoria.todo = todo;

    // === VERBOS ===
    const verbos = {
      are: ["parlare","mangiare","studiare","lavorare","abitare","ascoltare","guardare","camminare","giocare","ballare","cantare","nuotare","viaggiare","pagare","cercare","chiamare","aiutare","iniziare","prenotare","ordinare"],
      ere: ["leggere","vedere","scrivere","prendere","credere","rispondere","vivere","correre","perdere","vendere","temere","battere","offrire","aprire","coprire","soffrire","rompere","scoprire","descrivere","decidere"],
      ire: ["finire","dormire","partire","sentire","seguire","costruire","vestire","servire","preferire","obbedire","sorridere","fuggire","agire","riuscire","pulire","spedire","suggerire","nutrire","definire","riempire"]
    };

    const conjugaciones = {};
    const sujetosEs = ["yo", "t√∫", "√©l/ella", "nosotros", "vosotros", "ellos"];
    const tiempos = ["presente", "passato", "futuro"];

    function generarConjugaciones() {
      verbos.are.forEach(v => {
        const r = v.slice(0, -3);
        conjugaciones[v] = {
          presente: [r+"o", r+"i", r+"a", r+"iamo", r+"ate", r+"ano"],
          passato: ["ho "+r+"ato", "hai "+r+"ato", "ha "+r+"ato", "abbiamo "+r+"ato", "avete "+r+"ato", "hanno "+r+"ato"],
          futuro: [r+"er√≤", r+"erai", r+"er√†", r+"eremo", r+"erete", r+"eranno"]
        };
      });
      verbos.ere.forEach(v => {
        const r = v.slice(0, -3);
        conjugaciones[v] = {
          presente: [r+"o", r+"i", r+"e", r+"iamo", r+"ete", r+"ono"],
          passato: ["ho "+r+"uto", "hai "+r+"uto", "ha "+r+"uto", "abbiamo "+r+"uto", "avete "+r+"uto", "hanno "+r+"uto"],
          futuro: [r+"er√≤", r+"erai", r+"er√†", r+"eremo", r+"erete", r+"eranno"]
        };
      });
      verbos.ire.forEach(v => {
        const r = v.slice(0, -3);
        conjugaciones[v] = {
          presente: [r+"o", r+"i", r+"e", r+"iamo", r+"ite", r+"ono"],
          passato: ["ho "+r+"ito", "hai "+r+"ito", "ha "+r+"ito", "abbiamo "+r+"ito", "avete "+r+"ito", "hanno "+r+"ito"],
          futuro: [r+"ir√≤", r+"irai", r+"ir√†", r+"iremo", r+"irete", r+"iranno"]
        };
      });
    }
    generarConjugaciones();

    // === ESTADO GLOBAL ===
    let modo = null; // 'vocabulario', 'verbos', 'examen'
    let categoriaActual = null;
    let modoEscritura = false;
    let statsSesion = { aciertos: 0, errores: 0 };
    let errores = JSON.parse(localStorage.getItem('errores_italiano')) || [];
    let statsGlobal = JSON.parse(localStorage.getItem('stats_italiano')) || { aciertos: 0, errores: 0 };
    let examenActivo = false;
    let preguntasExamen = [];
    let indiceExamen = 0;
    let resultadosExamen = [];
    let temporizador = null;
    let tiempoRestante = 0;

    function actualizarStats() {
      document.getElementById('stats-sesion').textContent = 
        modo === 'examen' ? `Pregunta: ${indiceExamen + 1}/${preguntasExamen.length}` : 
        `Aciertos: ${statsSesion.aciertos} | Errores: ${statsSesion.errores}`;
      document.getElementById('stats-global').textContent = 
        `Total: ‚úÖ ${statsGlobal.aciertos} | ‚ùå ${statsGlobal.errores}`;
    }

    function guardarStats() {
      localStorage.setItem('stats_italiano', JSON.stringify(statsGlobal));
      localStorage.setItem('errores_italiano', JSON.stringify(errores));
    }

    function shuffle(a) {
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
    }
    // === MEN√öS ===
    function mostrarCategorias() {
      document.getElementById('menu-principal').style.display = 'none';
      document.getElementById('categorias').style.display = 'block';
    }

    function iniciarExamen() {
      document.getElementById('menu-principal').style.display = 'none';
      document.getElementById('examen-config').style.display = 'block';
    }

    function configurarExamen(numPreguntas, segundos = null) {
      examenActivo = true;
      modo = 'examen';
      modoEscritura = Math.random() > 0.5; // mezcla modos
      preguntasExamen = [];
      resultadosExamen = [];
      indiceExamen = 0;
      tiempoRestante = segundos;

      // Generar preguntas mezcladas
      const todasPalabras = vocabularioPorCategoria.todo;
      const todosVerbos = Object.keys(conjugaciones);
      const tipos = ['vocab', 'verbo'];

      for (let i = 0; i < numPreguntas; i++) {
        if (Math.random() > 0.4 && todosVerbos.length > 0) {
          // Pregunta de verbo
          const tipo = ["are","ere","ire"][Math.floor(Math.random()*3)];
          const verbo = verbos[tipo][Math.floor(Math.random()*verbos[tipo].length)];
          const tiempo = tiempos[Math.floor(Math.random()*3)];
          const suj = Math.floor(Math.random()*6);
          const correcta = conjugaciones[verbo][tiempo][suj];
          preguntasExamen.push({ tipo: 'verbo', verbo, tiempo, suj, correcta, contexto: `${verbo} (${tiempo}, ${sujetosEs[suj]})` });
        } else {
          // Pregunta de vocabulario
          const [es, it] = todasPalabras[Math.floor(Math.random() * todasPalabras.length)];
          preguntasExamen.push({ tipo: 'vocab', es, it, contexto: es });
        }
      }

      document.getElementById('examen-config').style.display = 'none';
      document.getElementById('juego').style.display = 'block';
      actualizarStats();

      if (segundos) {
        document.getElementById('examen-timer').style.display = 'block';
        actualizarTemporizador();
        temporizador = setInterval(() => {
          tiempoRestante--;
          if (tiempoRestante <= 0) {
            finalizarExamen();
          } else {
            actualizarTemporizador();
          }
        }, 1000);
      }

      mostrarSiguientePreguntaExamen();
    }

    function actualizarTemporizador() {
      const mins = Math.floor(tiempoRestante / 60);
      const secs = tiempoRestante % 60;
      document.getElementById('examen-timer').textContent = `‚è≥ Tiempo: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function mostrarSiguientePreguntaExamen() {
      if (indiceExamen >= preguntasExamen.length) {
        finalizarExamen();
        return;
      }

      const p = preguntasExamen[indiceExamen];
      actualizarStats();

      if (modoEscritura) {
        document.getElementById('opciones').style.display = 'none';
        document.getElementById('respuesta-escrita').style.display = 'block';
        document.getElementById('btn-enviar').style.display = 'block';
        document.getElementById('respuesta-escrita').value = '';
        document.getElementById('respuesta-escrita').focus();

        if (p.tipo === 'vocab') {
          document.getElementById('pregunta').textContent = `Escribe en italiano: "${p.es}"`;
          document.getElementById('btn-enviar').onclick = () => procesarRespuestaExamen(document.getElementById('respuesta-escrita').value.trim().toLowerCase(), p.it.toLowerCase(), p.contexto, p.tipo);
        } else {
          document.getElementById('pregunta').textContent = `Escribe la forma correcta de "${p.verbo}" en ${p.tiempo} para "${sujetosEs[p.suj]}":`;
          document.getElementById('btn-enviar').onclick = () => procesarRespuestaExamen(document.getElementById('respuesta-escrita').value.trim().toLowerCase(), p.correcta.toLowerCase(), p.contexto, p.tipo);
        }
      } else {
        document.getElementById('opciones').style.display = 'block';
        document.getElementById('respuesta-escrita').style.display = 'none';
        document.getElementById('btn-enviar').style.display = 'none';

        if (p.tipo === 'vocab') {
          let opciones = [p.it];
          while (opciones.length < 4) {
            const r = vocabularioPorCategoria.todo[Math.floor(Math.random() * vocabularioPorCategoria.todo.length)][1];
            if (!opciones.includes(r)) opciones.push(r);
          }
          shuffle(opciones);
          document.getElementById('pregunta').textContent = `¬øC√≥mo se dice "${p.es}" en italiano?`;
          for (let i = 0; i < 4; i++) {
            document.getElementById(`opcion${i}`).textContent = opciones[i];
            document.getElementById(`opcion${i}`).onclick = () => {
              reproducir(opciones[i]);
              procesarRespuestaExamen(opciones[i].toLowerCase(), p.it.toLowerCase(), p.contexto, p.tipo);
            };
          }
        } else {
          let todasFormas = [];
          for (let t of tiempos) {
            for (let f of conjugaciones[p.verbo][t]) {
              todasFormas.push(f);
            }
          }
          todasFormas = [...new Set(todasFormas)];
          let opciones = [p.correcta];
          while (opciones.length < 4 && opciones.length < todasFormas.length) {
            const candidato = todasFormas[Math.floor(Math.random() * todasFormas.length)];
            if (!opciones.includes(candidato)) opciones.push(candidato);
          }
          while (opciones.length < 4) {
            const otroVerbo = Object.keys(conjugaciones)[Math.floor(Math.random()*Object.keys(conjugaciones).length)];
            const otroTiempo = tiempos[Math.floor(Math.random()*3)];
            const otroSuj = Math.floor(Math.random()*6);
            const cand = conjugaciones[otroVerbo][otroTiempo][otroSuj];
            if (!opciones.includes(cand)) opciones.push(cand);
          }
          shuffle(opciones);
          document.getElementById('pregunta').textContent = `¬ø"${p.verbo}" en ${p.tiempo} para "${sujetosEs[p.suj]}"?`;
          for (let i = 0; i < 4; i++) {
            document.getElementById(`opcion${i}`).textContent = opciones[i];
            document.getElementById(`opcion${i}`).onclick = () => {
              reproducir(opciones[i]);
              procesarRespuestaExamen(opciones[i].toLowerCase(), p.correcta.toLowerCase(), p.contexto, p.tipo);
            };
          }
        }
      }
    }

    function procesarRespuestaExamen(respuesta, correcta, contexto, tipo) {
      const esCorrecta = respuesta === correcta;
      resultadosExamen.push({ contexto, dada: respuesta, correcta, esCorrecta });

      if (esCorrecta) {
        statsGlobal.aciertos++;
      } else {
        statsGlobal.errores++;
        errores.push({ tipo, contexto, dada: respuesta, correcta });
      }

      guardarStats();
      indiceExamen++;
      setTimeout(mostrarSiguientePreguntaExamen, 600);
    }

    function finalizarExamen() {
      if (temporizador) clearInterval(temporizador);
      examenActivo = false;

      const aciertos = resultadosExamen.filter(r => r.esCorrecta).length;
      const total = resultadosExamen.length;
      const porcentaje = Math.round((aciertos / total) * 100);

      // Guardar historial de ex√°menes
      const historial = JSON.parse(localStorage.getItem('examenes_italiano')) || [];
      historial.push({
        fecha: new Date().toLocaleString(),
        preguntas: total,
        aciertos,
        porcentaje
      });
      localStorage.setItem('examenes_italiano', JSON.stringify(historial));

      document.getElementById('juego').style.display = 'none';
      document.getElementById('examen-resultados').style.display = 'block';
      document.getElementById('resultados-contenido').innerHTML = `
        <p><strong>Preguntas:</strong> ${total}</p>
        <p><strong>Aciertos:</strong> ${aciertos}</p>
        <p><strong>Porcentaje:</strong> ${porcentaje}%</p>
        <p style="color:${porcentaje >= 80 ? 'green' : porcentaje >= 60 ? 'orange' : 'red'};">
          <strong>${porcentaje >= 80 ? '¬°Excelente!' : porcentaje >= 60 ? 'Bien hecho' : 'Sigue practicando'}</strong>
        </p>
      `;
    }

    function verDetallesExamen() {
      let html = '<h3>Detalles de tus respuestas:</h3>';
      resultadosExamen.forEach((r, i) => {
        html += `
          <div style="padding:10px; border-bottom:1px solid #eee;">
            <strong>P${i+1}: ${r.contexto}</strong><br>
            Tu respuesta: <span style="color:${r.esCorrecta ? 'green' : 'red'}">${r.dada || '(vac√≠o)'}</span><br>
            Correcto: ${r.correcta}
          </div>
        `;
      });
      document.getElementById('resultados-contenido').innerHTML = html + 
        '<button onclick="document.getElementById(\'examen-resultados\').style.display=\'none\'; document.getElementById(\'menu-principal\').style.display=\'block\';">Men√∫ principal</button>';
    }

    // === FUNCIONES EXISTENTES (vocabulario y verbos normales) ===
    function volverMenuJuego() {
      if (temporizador) clearInterval(temporizador);
      modo = null;
      categoriaActual = null;
      modoEscritura = false;
      examenActivo = false;
      statsSesion = { aciertos: 0, errores: 0 };
      document.getElementById('juego').style.display = 'none';
      document.getElementById('menu-principal').style.display = 'block';
      actualizarStats();
    }

    function toggleModo() {
      if (examenActivo) return; // No permitir en examen
      modoEscritura = !modoEscritura;
      const btn = document.querySelector('#juego button[onclick="toggleModo()"]');
      btn.textContent = modoEscritura ? '‚ÜîÔ∏è Cambiar a opci√≥n m√∫ltiple' : '‚ÜîÔ∏è Cambiar a modo escritura';
      document.getElementById('opciones').style.display = modoEscritura ? 'none' : 'block';
      document.getElementById('respuesta-escrita').style.display = modoEscritura ? 'block' : 'none';
      document.getElementById('btn-enviar').style.display = modoEscritura ? 'block' : 'none';
      if (modoEscritura) {
        document.getElementById('respuesta-escrita').focus();
      }
    }

    function iniciarVocabulario(categoria) {
      modo = 'vocabulario';
      categoriaActual = categoria;
      statsSesion = { aciertos: 0, errores: 0 };
      document.getElementById('categorias').style.display = 'none';
      document.getElementById('juego').style.display = 'block';
      actualizarStats();
      mostrarPreguntaVocabulario();
    }

    function mostrarPreguntaVocabulario() {
      const vocab = vocabularioPorCategoria[categoriaActual];
      const idx = Math.floor(Math.random() * vocab.length);
      const [es, it] = vocab[idx];

      if (modoEscritura) {
        document.getElementById('pregunta').textContent = `Escribe en italiano: "${es}"`;
        document.getElementById('respuesta-escrita').value = '';
        document.getElementById('btn-enviar').onclick = () => verificarRespuesta(document.getElementById('respuesta-escrita').value.trim().toLowerCase(), it.toLowerCase(), es, 'vocabulario');
      } else {
        let opciones = [it];
        while (opciones.length < 4) {
          const r = vocabularioPorCategoria.todo[Math.floor(Math.random() * vocabularioPorCategoria.todo.length)][1];
          if (!opciones.includes(r)) opciones.push(r);
        }
        shuffle(opciones);

        document.getElementById('pregunta').textContent = `¬øC√≥mo se dice "${es}" en italiano?`;
        for (let i = 0; i < 4; i++) {
          document.getElementById(`opcion${i}`).textContent = opciones[i];
          document.getElementById(`opcion${i}`).onclick = () => {
            reproducir(opciones[i]);
            verificarRespuesta(opciones[i].toLowerCase(), it.toLowerCase(), es, 'vocabulario');
          };
        }
      }
    }

    function iniciarVerbos() {
      modo = 'verbos';
      statsSesion = { aciertos: 0, errores: 0 };
      document.getElementById('menu-principal').style.display = 'none';
      document.getElementById('juego').style.display = 'block';
      actualizarStats();
      mostrarPreguntaVerbo();
    }

    function mostrarPreguntaVerbo() {
      const tipo = ["are","ere","ire"][Math.floor(Math.random()*3)];
      const verbo = verbos[tipo][Math.floor(Math.random()*verbos[tipo].length)];
      const tiempo = tiempos[Math.floor(Math.random()*3)];
      const suj = Math.floor(Math.random()*6);
      const correcta = conjugaciones[verbo][tiempo][suj];

      if (modoEscritura) {
        document.getElementById('pregunta').textContent = `Escribe la forma correcta de "${verbo}" en ${tiempo} para "${sujetosEs[suj]}":`;
        document.getElementById('respuesta-escrita').value = '';
        document.getElementById('btn-enviar').onclick = () => verificarRespuesta(document.getElementById('respuesta-escrita').value.trim().toLowerCase(), correcta.toLowerCase(), `${verbo} (${tiempo}, ${sujetosEs[suj]})`, 'verbos');
      } else {
        let todasFormas = [];
        for (let t of tiempos) {
          for (let f of conjugaciones[verbo][t]) {
            todasFormas.push(f);
          }
        }
        todasFormas = [...new Set(todasFormas)];

        let opciones = [correcta];
        while (opciones.length < 4 && opciones.length < todasFormas.length) {
          const candidato = todasFormas[Math.floor(Math.random() * todasFormas.length)];
          if (!opciones.includes(candidato)) {
            opciones.push(candidato);
          }
        }
        while (opciones.length < 4) {
          const otroVerbo = Object.keys(conjugaciones)[Math.floor(Math.random()*Object.keys(conjugaciones).length)];
          const otroTiempo = tiempos[Math.floor(Math.random()*3)];
          const otroSuj = Math.floor(Math.random()*6);
          const cand = conjugaciones[otroVerbo][otroTiempo][otroSuj];
          if (!opciones.includes(cand)) opciones.push(cand);
        }
        shuffle(opciones);

        document.getElementById('pregunta').textContent = `¬ø"${verbo}" en ${tiempo} para "${sujetosEs[suj]}"?`;
        for (let i = 0; i < 4; i++) {
          document.getElementById(`opcion${i}`).textContent = opciones[i];
          document.getElementById(`opcion${i}`).onclick = () => {
            reproducir(opciones[i]);
            verificarRespuesta(opciones[i].toLowerCase(), correcta.toLowerCase(), `${verbo} (${tiempo}, ${sujetosEs[suj]})`, 'verbos');
          };
        }
      }
    }

    function verificarRespuesta(respuesta, correcta, contexto, tipo) {
      if (respuesta === correcta) {
        statsSesion.aciertos++;
        statsGlobal.aciertos++;
        alert("¬°Correcto! ‚úÖ");
      } else {
        statsSesion.errores++;
        statsGlobal.errores++;
        errores.push({tipo, contexto, dada: respuesta, correcta});
        alert(`‚ùå Incorrecto.\nT√∫: ${respuesta}\nCorrecto: ${correcta}`);
      }
      guardarStats();
      actualizarStats();

      setTimeout(() => {
        if (modo === 'vocabulario') {
          mostrarPreguntaVocabulario();
        } else {
          mostrarPreguntaVerbo();
        }
      }, 600);
    }

    function mostrarErrores() {
      const div = document.getElementById("errores-lista");
      if (errores.length === 0) {
        div.innerHTML = "<p>¬°No tienes errores guardados! üåü</p>";
      } else {
        div.innerHTML = errores.map(e =>
          `<div><strong>${e.contexto}</strong><br/>Tu respuesta: ${e.dada}<br/>Correcto: ${e.correcta}</div><hr>`
        ).join('');
      }
      document.getElementById("errores").style.display = "block";
    }

    function reiniciarErrores() {
      errores = [];
      statsGlobal = { aciertos: 0, errores: 0 };
      localStorage.removeItem('examenes_italiano');
      guardarStats();
      document.getElementById("errores-lista").innerHTML = "<p>Errores y estad√≠sticas reiniciados.</p>";
      actualizarStats();
    }

    // === INICIAR ===
    actualizarStats();
  </script>
  <script>
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW registrado'))
        .catch(err => console.log('Error al registrar SW:', err));
    });
  }
  </script>
</body>
</html>
